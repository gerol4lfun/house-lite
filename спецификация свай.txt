Спецификация расчёта свай для калькулятора (текстом)
0) Константы (настройки проекта)

Предельный шаг рядов по длине, м: L_max = 3.0

Предельный шаг свай в ряду по ширине, м: W_max = 2.0

Минимум свай в одном ряду: 2

Числовая точность округления: все деления и сравнения выполнять с допуском ε = 1e−6 и округлять вверх (см. правило округления ниже).

Эти 2 шага (3,0 м и 2,0 м) калиброваны под практику: дают 6×6 → 12 свай, 6×7 → 15 свай, 6×3 → 9 свай и т.д. Их можно менять проектным решением — логика сохранится.

1) Входные данные

Строение описывается набором прямоугольников (корпус и любые веранды/пристройки):

Для каждого прямоугольника заданы 4 параметра в метрах:

x — координата левого края по длине,

y — координата нижнего края по ширине,

width — длина по оси X,

height — ширина по оси Y.

Если у пользователя только «L × W» без веранды — это один прямоугольник {x:0,y:0,width:L,height:W}.

2) Базовые определения

Объединённый контур U — геометрическое объединение всех прямоугольников (без наложения площадей).

Границы по длине:
X_min = минимальное x в U, X_max = максимальное (x + width) в U.
Полная протяжённость по длине: L_total = X_max − X_min.

3) Линии рядов свай (вдоль длины)

Разместить вертикальные линии рядов на координатах X так, чтобы расстояние между соседними линиями ≤ L_max (3,0 м) и линии стояли на краях.

Алгоритм размещения (словами):

Первая линия: X₀ = X_min.

Внутренние линии: последовательно добавлять линии вправо через шаг не более L_max. Разрешено ставить последний внутренний шаг меньше L_max, чтобы красиво «дотянуться» до края.

Последняя линия: X_last = X_max.

Проверка: ни один промежуток между соседними X-линиями не превышает L_max + ε.

Допустимо ставить строго через 3,0 м от левого края, а «остаток» сделать последним коротким шагом — это норм.

4) Локальная «ширина» на каждой линии ряда

Для каждой линии X = Xᵢ определить пересечение вертикали x = Xᵢ с объединённым контуром U. Оно даст один или несколько отрезков по ширине (по оси Y).
Локальную ширину на линии считаем как сумму длин всех отрезков:

W_local(Xᵢ) = Σ (y₂ − y₁) по всем отрезкам пересечения.

Это автоматически учитывает веранды/выступы: где веранда есть — W_local больше; где её нет — W_local равна ширине корпуса. Если на линии два раздельных «языка» (редко) — оба суммируются.

5) Количество свай в ряду (поперёк ширины)

Для каждой линии ряда Xᵢ вычислить число свай в ряду:

Сначала вычислить необходимое количество интервалов по ширине:
kᵢ = ceil( W_local(Xᵢ) / W_max ) (округление вверх, см. ниже).

Тогда число свай в ряду:
colsᵢ = max( 2, kᵢ + 1 ).

Пояснение: если шаг между сваями должен быть ≤ 2,0 м, то ширина разбивается на kᵢ интервалов, а свай нужно на одну больше — по краям. Минимум — 2 сваи в ряд.

6) Итоговое количество свай

N_total = Σ colsᵢ по всем линиям рядов.

7) Округление и допуски (важно!)

Везде, где есть ceil( … ), применять округление вверх с допуском:

считать ceil(a) как «наименьшее целое n, такое что n − 1 < a ≤ n»,

перед сравнением a нормализовать: если |a − целое| ≤ ε, считать a целым.

Это убирает «скачки» из-за 2.000000001 и т.п.

8) Выходные данные

Калькулятор должен возвращать:

piles_total — общее число свай N_total;

rows_count — число рядов (кол-во линий по длине);

rows[] — массив с данными по каждому ряду:

x — координата ряда,

width_local — W_local(x),

piles_in_row — cols для этого ряда.

S_total — общая площадь объединённого контура U (м²) — это пригодится для тарифов доставки по площади.

9) Примеры (проверка здравого смысла)
Пример 1. Корпус 6×6 (без веранды)

Длина: 6 → ряды: 0 м, 3 м, 6 м (трёх рядов достаточно: шаг ≤3,0).

На каждой линии ширина 6 м: W_local = 6.

Интервалы по ширине: ceil(6 / 2) = 3 → свай в ряду 3 + 1 = 4.

Итого: 3 ряда × 4 = 12 свай.

Пример 2. Корпус 6×7

Ряды: 0, 3, 6.

W_local = 7. Интервалы: ceil(7 / 2) = 4 → свай в ряду 4 + 1 = 5.

Итого: 3 × 5 = 15 свай.

Пример 3. Корпус 6×3

Ряды: 0, 3, 6.

W_local = 3 → ceil(3 / 2) = 2 → свай в ряду 2 + 1 = 3.

Итого: 3 × 3 = 9 свай.

Пример 4. 6×3 + веранда 1,5×3 только на половине длины (x ∈ [3; 6], «сверху»)

Ряды: 0, 3, 6.

На x = 0: W_local = 3 → ceil(3/2)=2 → 3 сваи.

На x = 3 и x = 6: W_local = 4,5 → ceil(4,5/2)=ceil(2,25)=3 → 4 сваи в каждом.

Итого: 3 + 4 + 4 = 11 свай.
(Если хотим более жёстко — допускается W_max = 1,8 м → будет 13 свай.)

Важно: пример показывает, что веранда увеличивает сваи только там, где она реально расширяет ширину. Это и нужно в реальной жизни.

10) Валидация «на дурака» (перед выдачей результата)

Проверить, что между соседними рядами по X нет шага > L_max + ε.

Проверить, что для каждого ряда piles_in_row ≥ 2.

(Опционально) проверить «геотехнику» интервалов: если осевое расстояние между соседними сваями в ряду оказалось < 5 × D_лопасти (по проектному диаметру лопасти), подсветить предупреждение инженеру. Это редко случится при W_max = 2,0 м, но правило полезно.

11) Связка с тарифами по площади (для домиков)

Так как калькулятор обязан считать S_total (площадь объединённого контура), можно сразу отдавать и «₽/км» по вашей лестнице:

S ≤ 24 → 1 машина → 180 ₽/км

24 < S ≤ 42 → 2 машины → 200 ₽/км

42 < S ≤ 60 → 3 машины → 300 ₽/км

S > 60 → машин = 1 + ceil((S − 24)/18); ставка = машин == 1 ? 180 : 100×машин.

12) Что делать, если «тяжёлые узлы» (камин, лестница, перегородки)

Базовый результат по этой спецификации — минимум.

Если у менеджера/прораба есть точечные нагрузки:

добавить 1–2 сваи локально под узлом, не меняя общую сетку;

или уменьшить W_max и/или L_max для всего объекта (более частая сетка).

Короткая версия для карточки задачи

Разбить строение на прямоугольники, найти объединение U.

Ряды по X: от левого до правого края, с промежутками ≤ 3,0 м.

Для каждой линии Xᵢ: W_local = суммарная «толщина» U по Y;
colsᵢ = max(2, ceil(W_local / 2,0) + 1 − 1) → проще помнить: интервалов = ceil(W_local / 2,0), свай = интервалов + 1, но минимум 2.

Итог: сумма colsᵢ.

Все округления — вверх, с допуском 1e−6.

Возвращать piles_total, rows_count, список рядов (X, W_local, piles_in_row) и S_total.

ДОПОЛНЕНИЕ:

Решение: считать обе ориентации и брать корректный минимум
Константы (зафиксировать)

Предельный пролёт по длине (между рядами): L_max = 3.0 м

Предельный шаг свай по ширине (внутри ряда): W_max = 2.0 м

Минимум свай в одном ряду: 2

Допуск округления: ε = 1e−6 (для устойчивого ceil)

Вход (как уже есть в UI)

Пользователь вводит две стороны: A и B (сейчас они подписаны «ширина/длина», но нам уже всё равно, кто из них кто).

Расчёт (делается ВСЕГДА в двух ориентациях)

Схема 1 — ряды вдоль A, сваи по B

Рядов: rows_A = ceil(A / L_max) + 1

Свай в ряду: cols_B = max(2, ceil(B / W_max) + 1)

Всего: N1 = rows_A × cols_B

Схема 2 — ряды вдоль B, сваи по A

Рядов: rows_B = ceil(B / L_max) + 1

Свай в ряду: cols_A = max(2, ceil(A / W_max) + 1)

Всего: N2 = rows_B × cols_A

Ограничение «чтобы длинная сторона не осталась без среднего ряда»

Пусть M = max(A, B).

Требуемый минимум рядов: rows_min = ceil(M / L_max) + 1.

Схема считается валидной, если её число рядов ≥ rows_min.

Это убирает неправильные случаи вроде «6×3 → 8 свай».

Выбор результата

Из валидных схем выбрать минимальное N.

В ответе обязательно отдать ориентацию, без сюрпризов для бригады:

«Ряды вдоль … м, в ряду свай: … шт; итог: … свай».

Округление (ключ к стабильности)

Все ceil() делать устойчиво: если |x − целое| ≤ ε, считать x целым; иначе обычный потолок.

Не использовать трюки вида ceil(x − ε).

Что это даёт прямо на твоих размерах

3×6
Схема 1 (ряды вдоль 3): rows=2 → не валидна (надо ≥3).
Схема 2 (ряды вдоль 6): rows=3, cols=3 → 9 свай → ответ 9, «ряды вдоль 6 м».

6×6
Обе валидны: rows=3, cols=4 → 12 свай → ответ 12.

6×7
Схема 1 (ряды вдоль 6): rows=3, cols=5 → 15 свай (валидна).
Схема 2 (ряды вдоль 7): rows=4, cols=4 → 16 свай (валидна).
→ ответ 15, «ряды вдоль 6 м».

7×4
Схема 1 (ряды вдоль 7): rows=4, cols=3 → 12 свай (валидна).
Схема 2 (ряды вдоль 4): rows=3, cols=4 → 12 свай, не валидна (надо ≥4).
→ ответ 12, «ряды вдоль 7 м».

И главная фишка: теперь не важно, где в UI стоит «ширина», где «длина». Калькулятор сам проверит обе ориентации и выберет корректную.

Веранды — как обойтись «на сейчас»

Если сейчас веранда задаётся одним числом (без геометрии по длине), делаем честно для обеих схем:

В каждой из двух ориентаций прибавляем вынос веранды к стороне, которая в этой схеме является “шириной ряда”.

Считаем N1 и N2 с учётом этого; берём минимум из валидных.
Позже можно перейти на «локальную ширину по рядам» — но это уже без боли.

Что показать пользователю/бригаде (выход)

Итоговое число свай: N

Ориентация: «ряды вдоль A (или B)»

Пояснение: «шаг рядов ≤ 3 м; в ряду шаг ≤ 2 м; края всегда»

(Опционально) «Чтобы получить меньше свай — разверните лаги вдоль меньшей стороны; калькулятор уже выбрал оптимальный вариант.»

Мини-чек-лист для разработчиков

Считать две схемы (вдоль A и вдоль B).

Применить rows_min = ceil(max(A,B)/3)+1.

Взять минимум N среди валидных схем.

Вернуть ориентацию в ответе.

Округления — только устойчивый ceil с ε.

Веранда (простая модель) — добавлять к «ширине ряда» в каждой схеме, считать обе, брать минимум.

РАСЧЁТ СВАЙ — ТЕХНИЧЕСКОЕ ОПИСАНИЕ (ТЕКСТОМ)

Константы (зафиксировать):
— предельный пролёт между рядами по длине: L_max = 3,0 м;
— предельный шаг свай в одном ряду по ширине: W_max = 2,0 м;
— минимум свай в одном ряду: 2 шт;
— допуск для округлений: ε = 1e−6.

Интерпретация полей формы (важно):
— поле «Длина (L)» — это ось, вдоль которой ставятся ряды свай;
— поле «Ширина (W)» — это поперечное направление; по нему считаем сколько свай в каждом ряду.
НИКОГДА не менять L и W местами внутри расчёта.

Как определить число рядов по длине:
— ряды стоят на обоих краях по длине;
— внутри добавляются так, чтобы расстояние между соседними рядами никогда не превышало L_max;
— формально: rows = ceil(L / L_max) + 1.
Пример: L=6 → ceil(6/3)=2 → 2+1=3 ряда; L=7 → ceil(7/3)=3 → 4 ряда.

Как определить, сколько свай в одном ряду по ширине:
— по краям ряда всегда сваи;
— шаг между сваями в ряду не больше W_max;
— формально: посчитать число интервалов ceil(W / W_max) и добавить одну сваю для второго края:
piles_in_row = max(2; ceil(W / W_max) + 1).
Пример: W=6 → ceil(6/2)=3 интервала → свай в ряду 3+1=4; W=7 → ceil(7/2)=4 → свай 5.

Итоговое количество свай:
— total_piles = rows × piles_in_row.

Округление (устойчивое):
— если число почти целое (|x − n| ≤ ε), считать его ровно n;
— далее применять обычный потолок (ceil).
НИГДЕ не использовать приёмы вида «ceil(x − ε)».

Веранды (упрощённо, пока без геометрии):
— если веранда идёт по всей длине, считать расширенную ширину: W′ = W + вынос веранды;
— если веранда «внутренняя», ширину не увеличивать;
— если веранда только на части длины, пока показывать подсказку: «локально может потребоваться больше свай в рядах, где есть веранда». (Когда будет возможность — перейдём на локальную ширину по рядам.)

Что выводить пользователю вместе с числом свай:
— «Рядов по длине: N (расставлены через ≤3 м)»;
— «Свай в каждом ряду: M (шаг по ширине ≈ W/(M−1) ≤ 2 м)»;
— «Итого свай: N×M = …».
Это снимает вопросы у бригады.

ПРИМЕРЫ (ДОЛЖНЫ ПОЛУЧАТЬСЯ ТОЧНО ТАК ЖЕ):

• Дом 6×3:
L=6 → ряды: 3; W=3 → в ряду: 3; итого 3×3 = 9 свай.

• Дом 6×4:
L=6 → ряды: 3; W=4 → в ряду: 3; итого 9 свай.

• Дом 6×5:
L=6 → ряды: 3; W=5 → в ряду: 4; итого 12 свай.

• Дом 6×6:
L=6 → ряды: 3; W=6 → в ряду: 4; итого 12 свай.

• Дом 6×7:
L=6 → ряды: 3; W=7 → в ряду: 5; итого 15 свай.

• Дом 7×4:
L=7 → ряды: 4; W=4 → в ряду: 3; итого 12 свай.

• Дом 7×5:
L=7 → ряды: 4; W=5 → в ряду: 4; итого 16 свай.

• Дом 7×7:
L=7 → ряды: 4; W=7 → в ряду: 5; итого 20 свай.

• Дом 8×3:
L=8 → ряды: 4; W=3 → в ряду: 3; итого 12 свай.

• Дом 8×4:
L=8 → ряды: 4; W=4 → в ряду: 3; итого 12 свай.

• Дом 8×6:
L=8 → ряды: 4; W=6 → в ряду: 4; итого 16 свай.

• Дом 9×3:
L=9 → ряды: 4; W=3 → в ряду: 3; итого 12 свай.

• Дом 9×6:
L=9 → ряды: 4; W=6 → в ряду: 4; итого 16 свай.

• Дом 10×4:
L=10 → rяды: ceil(10/3)+1 = 3+1 = 4; W=4 → в ряду: 3; итого 12 свай.
(Пояснение: при L=10 ряды будут 0–3–6–9–10; последний шаг 1 м допустим, потому что не превышает 3 м.)

• Дом 6×3 с верандой 1,5 м по всей длине:
ширина W′=3+1,5=4,5 → в ряду: ceil(4,5/2)+1 = 3+1 = 4;
ряды по длине 6 м: 3; итого 12 свай.
(Если перейти на точную локальную ширину по рядам, веранда только на половине длины дала бы 11 свай — это следующий этап развития.)

• Дом 6×7 — можно ли 12 свай?
Нет в «стандарте»: 3×4 даёт поперечный шаг 7/(4−1)=2,33 м, что больше 2,0 м;
4×3 даёт продольный шаг 7/3≈2,33 м — норм, но поперёк 6/(3−1)=3,0 м — больше 2,0 м.
Стандартный ответ 15 свай (3 ряда × 5).

• Дом 6×6 — почему не 16?
Потому что поперечный шаг допускается до 2,0 м. Для 6 м это 3 интервала → 4 сваи в ряду.
При 3 рядах это 12 свай. Увеличивать до 16 смысла нет на «стандарте».

• Дом 3×6 и дом 6×3 — результат один и тот же?
Да, если пользователь вводит «Длина=6, Ширина=3». Если в форме кто-то перепутает местами, мы всё равно считаем от полей: ряды вдоль того, что введено как «Длина», сваи в ряду по тому, что введено как «Ширина». Поэтому фиксируем подписи в UI и не переставляем параметры в коде.

КРАТКАЯ ПРОВЕРКА ДЛЯ QA (должно совпасть):
3×6 → 9; 6×6 → 12; 6×7 → 15; 7×4 → 12; 7×7 → 20; 8×6 → 16.